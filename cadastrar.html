<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro</title>
    <!-- Latest compiled and minified CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">


    <!-- Latest compiled JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</head>

<body class="bg-light">
    <div class="offcanvas offcanvas-start" id="demo" style="width: 250px; background-color: var(--bs-gray-200);">
        <div class="offcanvas-header">
            <div class="justify-content-center align-items-center">
                <img src="./img/logo.png" alt="" class="img-fluid me-2" width="45" height="45">
                <img src="./img/logo2.png" alt="" class="img-fluid" width="120" height="120">
            </div>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <ul class="navbar-nav">
                <li class="d-flex align-items-center mb-2">
                    <img src="./img/house.svg" alt="Ícone de lista" class='img-fluid'
                        style="height: 20px; width: auto;">
                    <a href="./index.html" class="nav-link ms-2">Home</a>
                </li>
                <li class="d-flex align-items-center mb-2">
                    <img src="./img/card-checklist.svg" alt="Ícone de lista" class='img-fluid'
                        style="height: 20px; width: auto;">
                    <a href="./tarefas.html" class="nav-link ms-2">Tarefas</a>
                </li>
                <li class="d-flex align-items-center mb-2">
                    <img src="./img/easel.svg" alt="Ícone de projetor" class='img-fluid'
                        style="height: 20px; width: auto;">
                    <a href="./projeto.html" class="nav-link ms-2">Projetos</a>
                </li>
                <li class="d-flex align-items-center mb-2">
                    <img src="./img/people.svg" alt="Ícone de usuários" class='img-fluid'
                        style="height: 20px; width: auto;">
                    <a href="./usuarios.html" class="nav-link ms-2">Usuários</a>
                </li>
                <li class="d-flex align-items-center mb-2">
                    <img src="./img/person-vcard.svg" alt="Ícone de documento" class='img-fluid'
                        style="height: 20px; width: auto;">
                    <a href="./curriculo.html" class="nav-link ms-2">Currículo</a>
                </li>
            </ul>
        </div>
    </div>

    <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
        <div class="container-fluid">
            <ul class="navbar-nav">
                <li>
                    <img src="./img/logo.png" alt="logo" class="img-fluid me-2 ms-2" width="30" height="30">
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="" data-bs-toggle="offcanvas" data-bs-target="#demo">Menu</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="./usuarios.html">Usuários</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link disabled" href="./cadastrar.html">Cadastro</a>
                </li>
            </ul>
            <div class="me-2">
                <a href="./login.html"><img src="./img/box-arrow-right.svg" alt="logo" class="img-fluid" width="24"
                        height="24"></a>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <div class="row">
            <div class="col-2"></div>
            <div class="col">
                <div class="card shadow">
                    <div class="card-header fw-bold h5">
                        Cadastro de usuário
                    </div>
                    <div class="card-body">
                        <form action id="formCadastro">
                            <div class="row">
                                <div class="col-12">
                                    <p class="small">Preencha as informações abaixo para cadastrar um novo usuário no
                                        sistema.</p>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <label for="nome" class="form-label">Nome: </label>
                                    <input type="text" class="form-control" id="nome" name="nome"
                                        placeholder="Informe seu nome" required>
                                    <p id="texto-erro-1" class="small text-danger mt-2"></p>
                                </div>
                                <div class="col">
                                    <label for="cpf" class="form-label">CPF: </label>
                                    <input type="text" class="form-control" id="cpf" name="cpf" maxlength="14"
                                        placeholder="xxx.xxx.xxx-xx" required>
                                    <p id="texto-erro-2" class="small text-danger mt-2"></p>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <label for="email" class="form-label">E-mail: </label>
                                    <input type="email" class="form-control" id="email" name="email"
                                        placeholder="exemplo@dominio.com" required>
                                    <p id="texto-erro-3" class="small text-danger mt-2"></p>
                                </div>
                                <div class="col">
                                    <label for="data" class="form-label">Data de nascimento: </label>
                                    <input type="date" class="form-control" id="data" name="data">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <label for="senha" class="form-label">Senha: </label>
                                    <div class="row">
                                        <div class="col">
                                            <input type="password" class="form-control" id="senha" name="senha"
                                                minlength="8" placeholder="Informe sua senha"
                                                pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&.])[A-Za-z\d@$!%*?&.]{8,}$"
                                                required />
                                        </div>
                                        <div class="col-2">
                                            <button class="btn btn-outline-secondary" type="button"
                                                onclick="mostrarSenha()"
                                                style="border-color: var(--bs-secondary-bg-subtle);">
                                                <i class="bi-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <p id="texto-erro-4" class="small text-danger mt-2"></p>
                                </div>
                                <div class="col">
                                    <label for="confirmeSenha" class="form-label">Confirme a senha: </label>
                                    <input type="password" class="form-control" id="confirmeSenha" name="confirmeSenha"
                                        minlength="8" placeholder="Repita sua senha"
                                        pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&.])[A-Za-z\d@$!%*?&.]{8,}$"
                                        required>
                                    <p id="texto-erro-5" class="small text-danger mt-2"></p>

                                </div>
                            </div>
                            <div class="row my-3">
                                <div class="col-12 small">
                                    <ul>
                                        <li>Mínimo de 8 caracteres.</li>
                                        <li>Pelo menos uma letra maiúscula e minúscula.</li>
                                        <li>Pelo menos um número.</li>
                                        <li>Pelo menos um caractere especial.</li>
                                    </ul>
                                </div>
                            </div>
                            <!-- 
                            PATTERN:
                            ?= → Uma lookahead assertion, que verifica se um determinado padrão está presente na string sem consumir caracteres.
                            .* → Qualquer sequência de caracteres antes do que estamos buscando.
                            \d → Pelo menos um número (0-9).
                            -->

                            <div class="row">
                                <div class="col">
                                    <label for="status" class="form-label">Status: </label>
                                    <select name="status" class="form-select" id="status">
                                        <option value="" disabled selected>Selecione</option>
                                        <option value="1">Ativo</option>
                                        <option value="0">Inativo</option>
                                    </select>
                                </div>
                            </div>
                            <div class="text-end mt-3">
                                <button class='btn btn-secondary btn-block me-sm-3'
                                    onclick="window.location.href='usuarios.html'">Cancelar</button>
                                <input type="button" class='btn btn-primary btn-block' onclick="validarECadastrar()"
                                    value="Enviar">
                            </div>
                        </form>
                    </div>

                </div>

            </div>
            <div class="col-2"></div>
        </div>
    </div>

    <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="successModalLabel">Sucesso!</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    O usuário foi cadastrado com sucesso.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" id="btn-fechar-modal">Ok</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function validarECadastrar() {
            validarForms();
            cadastrar();
        };

        let ultimoIdCadastrado = 0;

        function cadastrar() {
            // ultimoIdCadastrado++;
            // const novoId = String(ultimoIdCadastrado).padStart(2, '0');

            const myObj = {
                // "id": novoId,
                "nome": document.getElementById("nome").value,
                "cpf": document.getElementById("cpf").value,
                "email": document.getElementById("email").value,
                "senha": document.getElementById("senha").value,
                "dataNascimento": document.getElementById("data").value,
                "status": document.getElementById("status").value
            };
            const objSend = JSON.stringify(myObj);

            fetch('http://localhost:8081/usuarios/cadastrar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer seu_token_aqui'
                },
                body: objSend
            })
                .then(response => {
                    return response.json();
                })
                .then(data => {
                    console.log('Resposta da API:', data);
                    if (data.mensagem === "Usuário cadastrado com sucesso.") {
                        var successModal = new bootstrap.Modal(document.getElementById('successModal'));
                        successModal.show();
                    }
                    let erros = "<br>";
                    for (var i = 0; i < data.erros.length; i++) {
                        erros = erros + data.erros[i] + '<br>';
                    }
                    exibir_mensagem('<strong>' + data.mensagem + '</strong>' + erros);
                })
                .catch(error => {
                    console.error('Erro:', error);
                });

            document.getElementById("btn-fechar-modal").addEventListener("click", function () {
                location.reload();
            });
        }

        function mostrarSenha() {
            if (document.getElementById('senha').type == 'password') {
                document.getElementById('senha').setAttribute('type', 'text');
            } else {
                document.getElementById('senha').setAttribute('type', 'password');
            }
        }

        function exibirMensagem(idParagrafo, mensagem) {
            document.getElementById(idParagrafo).innerHTML = mensagem;
        }

        function validarForms() {
            let nome = document.getElementById('nome').value;
            let email = document.getElementById('email').value;
            let cpf = document.getElementById('cpf').value;
            let senha = document.getElementById('senha').value;
            let confirmarSenha = document.getElementById('confirmeSenha').value;

            const regexCPF = /^\d{3}\.\d{3}\.\d{3}-\d{2}$/;
            const regexSenha = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{8,}$/;

            if (nome.trim() === '') {
                exibirMensagem('texto-erro-1', 'Por favor, preencha este campo.');
                document.getElementById('nome').focus();
                return;
            } else {
                exibirMensagem('texto-erro-1', '');
            }

            if (nome.trim().length <= 2) {
                exibirMensagem('texto-erro-1', 'O nome deve ter pelo menos 3 caracteres.');
                document.getElementById('nome').focus();
                return;
            } else {
                exibirMensagem('texto-erro-1', '');
            }

            if (nome.trim().length > 255) {
                exibirMensagem('texto-erro-1', 'O nome não pode ultrapassar 255 caracteres.');
                document.getElementById('nome').focus;
                return;
            } else {
                exibirMensagem('texto-erro-1', '');
            }

            function verificarCPFIgual(cpf) {
                let cpfNumerico = cpf.replace(/\D/g, '');
                return cpfNumerico.split('').every(char => char === cpfNumerico[0]);
            }

            if (regexCPF.test(cpf) == false || verificarCPFIgual(cpf)) {
                exibirMensagem('texto-erro-2', verificarCPFIgual(cpf) ? 'CPF inválido: todos os números são iguais.' : 'Informe o CPF no formato xxx.xxx.xxx-xx');
                document.getElementById('cpf').focus();
                return;
            } else {
                exibirMensagem('texto-erro-2', '');
            }

            if (!email.includes('@' && '.com')) {
                exibirMensagem('texto-erro-3', 'Por favor, insira um formato de e-mail válido.');
                document.getElementById('email').focus();
                return;
            } else {
                exibirMensagem('texto-erro-3', '');
            }

            if (regexSenha.test(senha) == false) {
                exibirMensagem('texto-erro-4', 'A senha não atende os requisitos listados abaixo.');
                document.getElementById('senha').focus();
                return;
            } else {
                exibirMensagem('texto-erro-4', '');
            }

            if (senha != confirmarSenha) {
                exibirMensagem('texto-erro-5', 'Insira a mesma senha.');
                document.getElementById('confirmeSenha').focus();
                return;
            } else {
                exibirMensagem('texto-erro-5', '');
            }
        };

    </script>

</body>

</html>